name: Build iOS IPA (unsigned)

on:
  workflow_dispatch:

env:
  GODOT_VERSION: 4.3-stable
  IOS_PRESET: iOS
  NAME: GoodbyeEternity
  HOMEBREW_NO_AUTO_UPDATE: 1

jobs:
  build-ios:
    runs-on: macos-14
    timeout-minutes: 30

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Download Godot headless
      run: |
        curl -L "https://github.com/godotengine/godot-builds/releases/download/${GODOT_VERSION}/Godot_v${GODOT_VERSION}_macos.universal.zip" -o godot.zip
        unzip -q godot.zip -d godot

    - name: Download and install iOS export template
      run: |
        templates_root="$HOME/Library/Application Support/Godot/export_templates/4.3.stable"
        mkdir -p "$templates_root"
        curl -L "https://dl.dropboxusercontent.com/scl/fi/qg4ofedro2xsr0wtyz6sd/ios.zip?rlkey=avw6jlbtcztrenumz9wb2nwd9&dl=1" -o "$templates_root/ios.zip"

    - name: Export to Xcode project
      run: |
        mkdir -p build/ios
        godot/Godot.app/Contents/MacOS/Godot --headless --path . \
          --export-release "${IOS_PRESET}" build/ios/${NAME}.xcodeproj

    - name: Build Xcode project (unsigned)
      run: |
        xcodebuild archive \
          -project build/ios/${NAME}.xcodeproj \
          -scheme "${NAME}" \
          -archivePath build/ios/App.xcarchive \
          -configuration Release \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          | xcpretty

    - name: Package IPA
      run: |
        cd build/ios
        mkdir -p Payload
        cp -R App.xcarchive/Products/Applications/*.app Payload/
        zip -r "${NAME}.ipa" Payload
        mv "${NAME}.ipa" ../../

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: unsigned-ipa
        path: GoodbyeEternity.ipa
